#!/usr/bin/env perl 

use Carp::Reply;

BEGIN {
  $consoante=qr{[bcçdfghjklmñnpqrstvwyxz]}i;
  $vogal=qr{[áéíóúâêôãõàèaeiouüöäëï]}i;
  $acento=qr{[áéíóúâêôãõüöäëï]}i;
  setlocale(&POSIX::LC_ALL, "pt_PT");

  use POSIX;
  POSIX::setlocale(LC_CTYPE,"pt_PT");

  $lmax = 1000000;
  $maxlog = 13.815;
  $magicF = $maxlog/log($lmax);
}


my %syl = (
   20 => " -.!?:;",
   10 => "bçdfgjkpqtv",
   8 => "sc",
   7 => "m",
   6 => "lzx",
   5 => "nr",
   4 => "h",
   3 => "wy",
   2 => "eaoáéíóúôâêûàãõäëïöü",
   1 => "iu",
   breakpair =>
      #"ie|ia|io|ee|oo|oa|sl|sm|sn|sc|sr|rn|bc|lr|lz|bd|bj|bg|bq|bt|bv|pt|pc|dj|pç|ln|nr|mn|tp|bf|bp",
      "sl|sm|sn|sc|sr|rn|bc|lr|lz|bd|bj|bg|bq|bt|bv|pt|pc|dj|pç|ln|nr|mn|tp|bf|bp|xc|sç|ss|rr",
        # dígrafos que se separam sempre: xc, sç, ss, rr, sc.
  );

my %spri = ();

for my $pri (grep(/\d/, keys %syl)){
  for(split(//,$syl{$pri})) { $spri{$_} = $pri}}

my $sylseppair;
($sylseppair= $syl{breakpair}) =~ s/(\w)(\w)/(\?<=($1))(\?=($2))/g;


sub syllable{
  my $p=shift;

  for($p){
    s/$sylseppair/|/g;
    s{(\w)(?=(\w)(\w))}
      {if($spri{lc($1)}<$spri{lc($2)} && $spri{lc($2)}>=$spri{lc($3)}){"$1|"}
       else{$1}
      }ge;

    s{([a])(i[ru])$}{$1|$2}i;   #ditongos and friends

    #s{([ioeê])([aoe])}{$1|$2}ig; # not this simple
    s{(?<!^h)([ioeê])([e])}{$1|$2}ig;   #
    s{([ioeêé])([ao])}{$1|$2}ig;    # la|go|a; di|a; ru|bé|o|la; né|on; au|ré|o|la

    s{([^qg]u)(ai|ou|a)}{$1|$2}i;   # BUGFIX:  [^q]: qu|a|se => qua|se
    s{([^qgc]u)(i|ei|iu|ir|$acento|e)}{$1|$2}i; # continu|e
    s{([lpt]u)\|(i)(?=\|[ao])}{$1$2}ig;  # a|le|lui|a ta|pui|a con|lui|o
    s{([^q]u)(o)}{$1|$2}i;      # quo|ta; vácu|o
    s{([aeio])($acento)}{$1|$2}i;
    s{([íúô])($vogal)}{$1|$2}i;
    s{^a(o|e)}{a|$1}i;                  # a|onde; a|orta; a|eródromo

    # Exemplo: his|tó|ria
    if( m/([\w\|]*$acento[\w\|]*)\-/) {
      if ( m/([eiou])\|([aeio])\-/ ) { # palavras com hifen
        s{([eiou])\|([aeio])(?=\-)}{$1$2}ig if $1 ne $2 ;
      }
    }
    if ( m/([\w\|]*$acento[\w\|]*)$/ ) {
      if ( m/([eiou])\|([aeio])$/ ) {
        s{([eiou])\|([aeio])$}{$1$2}ig if $1 ne $2 ;
      }
    }

    #s{([qg]u)\|([eií])}{$1$2}i;

    s{rein}{re|in}ig;  # re|in|ves|tir
    s{ae}{a|e}ig; # ma|ca|en|se ; es|ma|e|cer
    s{ain}{a|in}ig;  # a|in|da con|tra|in|for|mar pa|in|ço
    s{ao(?!s)}{a|o}ig; # ca|o|ti|ca|men|te ; ma|o|me|tis|mo != caos
    s{cue}{cu|e}ig; # ar|cu|en|se
    s{cui(?=\|?[mnr])}{cu|i}ig; #
    s{cui(?=\|da\|de$)}{cu|i}ig; # pro|mis|cu|i|da|de; i|no|cu|i|da|de
    s{coi(?=[mn])}{co|i}ig; # co|in|ci|den|te;
    s{cai(?=\|?[mnd])}{ca|i}ig; # des|ca|i|de|la; des|ca|i|men|to
    s{ca\|i(?=\|?[m]$acento)}{cai}ig; # cai|mão
    s{cu([áó])}{cu|$1}ig; # pe|cu|á|ria va|cu|ó|me|tro
    s{ai(?=\|?[z])}{a|i}ig; # ra|iz ; en|ra|i|zar
    s{i(u\|?)n}{i|$1n}ig; # tri|un|fo
    s{i(u\|?)r}{i|$1r}ig; # di|ur|no
    s{i(u\|?)v}{i|$1v}ig; # viuvar
    s{i(u\|?)l}{i|$1l}ig; # friulano
    s{ium}{i|um}ig; # médium
    s{([ta])iu}{$1i|u}ig; # multiuso , baiuca,  maiusculizar
    s{miu\|d}{mi|u|d}ig; # miudinho
    s{au\|to(?=i)}{au|to|}ig; # au|to|i|ma|gem
    s{(?<=$vogal)i\|nh(?=[ao])}{|i|nh}ig; # # ven|to|i|nha
    s{oi([mn])}{o|i$1}ig; # a|men|do|im monoinsaturado microinjecção
    s{oi\|b}{o|i|b}ig; # proibido
    s{ois(?!$)}{o|is}ig; # ma|o|is|mo ; e|go|is|ti|ca|men|te
    s{o(i\|?)s(?=$acento)}{o|$1s}ig; # ra|di|o|i|só|to|po
    s{([dtm])aoi}{$1a|o|i}ig; # da|o|is|ta ; ta|o|is|ta ; ma|o|is|ta
    s{(?<=[trm])u\|i(?=\|?[tvb][oa])}{ui}ig;
    # ?: gra|tui|ti|da|de vs in|tu|i|ti|vo

    s{^gas\|tro(?!-)}{gas|tro|}ig; # gas|tro|in|tes|ti|nal ; gas|tro-in|tes|ti|nal
    s{^fais}{fa|is}ig; # faiscar | faiscação
    s{^hie}{hi|e}ig; # hi|e|na ; hi|e|rar|ca
    s{^ciu}{ci|u}ig; # ci|u|men|to
    s{(?<=^al\|ca)\|i}{i}ig; # al|cai|de
    s{(?<=^an\|ti)(p)\|?}{|$1}ig; # anti
    s{(?<=^an\|ti)(\-p)\|?}{$1}ig; # anti
    s{(?<=^neu\|ro)p\|}{|p}ig; # neu|ro|psi|có|lo|go
    s{(?<=^pa\|ra)p\|}{|p}ig; # pa|ra|psi|có|lo|go
    s{(?<=^ne\|)op\|}{o|p}ig; # neopsicadélico
    s{^re(?=[i]\|?[md])}{re|}ig; # re|i|dra|ta|ção
    s{^re(?=i\|n[ií]\|c)}{re|}ig; # re|i|ni|ci|ar
    s{^re(?=i\|nau\|g)}{re|}ig; # re|i|nau|gu|rar
    s{^re(?=[u]\|?[ntsr])}{re|}ig; # re|u|so
    s{(?<=^vi\|de\|)o($vogal)}{o|$1}ig; # vi|de|o|a|ma|dor

    s{^su\|b(?!$vogal)}{sub|}ig;
    s{(?<=[\|\-])su\|b(?!$vogal)}{sub|}ig;
    s{^sub\|l(?=i\|?m)}{su|bl}ig; # su|bli|mar (excepção, compostas: sub|li|mi|nar sub|li|mi|te)
    s{(?<=\|)sub\|l(?=i\|?m)}{su|bl}ig;
    s{^sub\|l(?=i\|?nh)}{su|bl}ig;  # (excepção: sublinha)
    s{(?<=\|)sub\|l(?=i\|?nh)}{su|bl}ig;
    s{^sub\|s(?=\|?$vogal)}{sub|s}ig;
    s{(?<=\|)sub\|s(?=\|?$vogal)}{sub|s}ig;
    s{^sub\|s(?=\|?$consoante)}{subs|}ig;
    s{(?<=\|)sub\|s(?=\|?$consoante)}{subs|}ig;

    s{so\|bs}{sobs}ig; # de|sobs|tru|ir

    s{(?<=\|)trai(?=\|d)}{tra|i}ig;  # re|tra|i|da|men|te ; des|con|tra|i|da|men|te

    s{^e\|cze}{ec|ze}ig;  # ec|ze|ma

    s{^ex\|tra(?=$vogal)}{ex|tra|}ig; # ex|tra|or|di|na|ri|a|men|te

    s{u\|i$}{ui}ig; # institui ; chui ;
    s{\|?ói([ao])$}{ói|$1}ig; # jóia clarabóia
    s{ei([oa])(?=$|\-)}{ei|$1}ig; # ma|ré-chei|a mei|a-ir|mã meio

    s{^a\|([bd])([svqnmgfz])($vogal)}{a$1|$2$3}ig;  # ab|sin|to
    s{(?<=\|)a\|([bd])([svqnmgfz])($vogal)}{a$1|$2$3}ig;  # re|ab|sor|ção
    s{^a\|(b)(r)(o)(?=\|g)}{a$1|$2$3}ig;  # ab|ro|ga|ção
    s{^a\|([bd])([s])\|?($consoante)}{a$1$2|$3}ig;  # abs|trac|to
    s{^o\|([bd])([svqnmgfz])($vogal)}{o$1|$2$3}ig;  # ob|ser|var
    s{^o\|([bd])([s])\|?($consoante)}{o$1$2|$3}ig;  # obs|tru|ir
    s{([qg]u)\|([aeií])}{$1$2}i;
    s{([qg]u)\|([o])$}{$1$2}i;  # ambíguo; contíguo

    s{^($consoante)\|}{$1}i;
    #s{êm$}{ê|_nhem}i;      # removido após reunião do P-Pal a 2010-06-01

    s{tun\|gs}{tungs}ig;  # tungsténio

    s{p\|s$}{ps}i; # excepção de "ps" como breakpair
    s{(^p|\-p)\|s([ií])}{$1s$2}i; # excepção de "ps" como breakpair => mé|di|co-psi|co|ló|gi|co

    s{s\|s$}{ss}i; # excepção de "ss" como breakpair => fitness

    s{\|\|}{\|}g;
  }
  $p
}

Carp::Reply::repl();
